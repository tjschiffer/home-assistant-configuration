[{"id":"ff5dee0f.b55b5","type":"tab","label":"Baby Bouncer","disabled":false,"info":""},{"id":"329a6d0c.defab2","type":"tab","label":"Humidity","disabled":false,"info":""},{"id":"9582ddcc.9ab69","type":"tab","label":"Flux","disabled":false,"info":""},{"id":"63c71c5f.ed2ac4","type":"server","z":"","name":"Home Assistant"},{"id":"bd0c66f5.8d50a8","type":"position-config","z":"","name":"Hoboken","isValide":"true","longitude":"0","latitude":"0","angleType":"deg","timeZoneOffset":99,"timeZoneDST":0,"stateTimeFormat":"3","stateDateFormat":"12"},{"id":"e402d938.06a228","type":"ui_base","theme":{"name":"theme-light","lightTheme":{"default":"#0094CE","baseColor":"#0094CE","baseFont":"-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Oxygen-Sans,Ubuntu,Cantarell,Helvetica Neue,sans-serif","edited":true,"reset":false},"darkTheme":{"default":"#097479","baseColor":"#097479","baseFont":"-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Oxygen-Sans,Ubuntu,Cantarell,Helvetica Neue,sans-serif","edited":false},"customTheme":{"name":"Untitled Theme 1","default":"#4B7930","baseColor":"#4B7930","baseFont":"-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Oxygen-Sans,Ubuntu,Cantarell,Helvetica Neue,sans-serif"},"themeState":{"base-color":{"default":"#0094CE","value":"#0094CE","edited":false},"page-titlebar-backgroundColor":{"value":"#0094CE","edited":false},"page-backgroundColor":{"value":"#fafafa","edited":false},"page-sidebar-backgroundColor":{"value":"#ffffff","edited":false},"group-textColor":{"value":"#1bbfff","edited":false},"group-borderColor":{"value":"#ffffff","edited":false},"group-backgroundColor":{"value":"#ffffff","edited":false},"widget-textColor":{"value":"#111111","edited":false},"widget-backgroundColor":{"value":"#0094ce","edited":false},"widget-borderColor":{"value":"#ffffff","edited":false},"base-font":{"value":"-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Oxygen-Sans,Ubuntu,Cantarell,Helvetica Neue,sans-serif"}},"angularTheme":{"primary":"indigo","accents":"blue","warn":"red","background":"grey"}},"site":{"name":"Node-RED Dashboard","hideToolbar":"false","allowSwipe":"false","lockMenu":"false","allowTempTheme":"true","dateFormat":"DD/MM/YYYY","sizes":{"sx":48,"sy":48,"gx":6,"gy":6,"cx":6,"cy":6,"px":0,"py":0}}},{"id":"299dc613.77e94a","type":"server-state-changed","z":"ff5dee0f.b55b5","name":"Baby Bouncer Change","server":"63c71c5f.ed2ac4","version":1,"exposeToHomeAssistant":false,"haConfig":[{"property":"name","value":""},{"property":"icon","value":""}],"entityidfilter":"input_number.baby_bouncer","entityidfiltertype":"exact","outputinitially":false,"state_type":"num","haltifstate":"","halt_if_type":"str","halt_if_compare":"is","outputs":1,"output_only_on_state_change":true,"x":110,"y":160,"wires":[["6e1cbce2.045944"]]},{"id":"6e1cbce2.045944","type":"api-call-service","z":"ff5dee0f.b55b5","name":"Set PWM Delay","server":"63c71c5f.ed2ac4","version":1,"debugenabled":false,"service_domain":"esphome","service":"esp32_1_set_gpio13_pwm_delay","entityId":"","data":"{\"speed\":\"{{ entity.input_number.baby_bouncer | int }}\"}","dataType":"json","mergecontext":"","output_location":"","output_location_type":"none","mustacheAltTags":false,"x":360,"y":160,"wires":[[]]},{"id":"a03f88fe.a851c8","type":"api-current-state","z":"329a6d0c.defab2","name":"Current State Switch Off","server":"63c71c5f.ed2ac4","version":1,"outputs":2,"halt_if":"off","halt_if_type":"str","halt_if_compare":"is","override_topic":false,"entity_id":"switch.sonoff_s31_1_relay","state_type":"str","state_location":"payload","override_payload":"msg","entity_location":"data","override_data":"msg","blockInputOverrides":false,"x":310,"y":300,"wires":[["d5faa64d.49fd98"],[]]},{"id":"d5faa64d.49fd98","type":"api-call-service","z":"329a6d0c.defab2","name":"Turn On Humidifier","server":"63c71c5f.ed2ac4","version":1,"debugenabled":false,"service_domain":"switch","service":"turn_on","entityId":"switch.sonoff_s31_1_relay","data":"","dataType":"json","mergecontext":"","output_location":"","output_location_type":"none","mustacheAltTags":false,"x":550,"y":300,"wires":[[]]},{"id":"647a3d22.7feef4","type":"api-current-state","z":"329a6d0c.defab2","name":"Current State Switch On","server":"63c71c5f.ed2ac4","version":1,"outputs":2,"halt_if":"on","halt_if_type":"str","halt_if_compare":"is","override_topic":false,"entity_id":"switch.sonoff_s31_1_relay","state_type":"str","state_location":"payload","override_payload":"msg","entity_location":"data","override_data":"msg","blockInputOverrides":false,"x":310,"y":180,"wires":[["fa060018.5eab2"],[]]},{"id":"fa060018.5eab2","type":"api-call-service","z":"329a6d0c.defab2","name":"Turn Off Humidifier","server":"63c71c5f.ed2ac4","version":1,"debugenabled":false,"service_domain":"switch","service":"turn_off","entityId":"switch.sonoff_s31_1_relay","data":"","dataType":"json","mergecontext":"","output_location":"","output_location_type":"none","mustacheAltTags":false,"x":550,"y":180,"wires":[[]]},{"id":"723bc947.f173a8","type":"switch","z":"329a6d0c.defab2","name":"","property":"payload","propertyType":"msg","rules":[{"t":"gt","v":"50","vt":"num"},{"t":"lt","v":"40","vt":"num"}],"checkall":"false","repair":false,"outputs":2,"x":470,"y":240,"wires":[["647a3d22.7feef4"],["a03f88fe.a851c8"]]},{"id":"757d78fd.7247d8","type":"sun-position","z":"9582ddcc.9ab69","name":"","positionConfig":"bd0c66f5.8d50a8","rules":[],"onlyOnChange":"true","topic":"","outputs":1,"start":"","startType":"none","startOffset":0,"startOffsetType":"none","startOffsetMultiplier":60000,"end":"","endType":"none","endOffset":0,"endOffsetType":"none","endOffsetMultiplier":60000,"x":470,"y":180,"wires":[["75c5ff3f.6d63f"]]},{"id":"7c1f8a94.024834","type":"range","z":"9582ddcc.9ab69","minin":"0","maxin":"100","minout":"400","maxout":"180","action":"clamp","round":true,"property":"payload.color_temp","name":"Percent to Color Temp","x":500,"y":280,"wires":[["400181bb.2fc33"]]},{"id":"6805e137.616f8","type":"inject","z":"9582ddcc.9ab69","name":"Every 5 minutes","topic":"","payload":"","payloadType":"date","repeat":"300","crontab":"","once":true,"onceDelay":"0.1","x":590,"y":60,"wires":[["cf14760b.801858","8a6acec9.2159f"]]},{"id":"b01ab9f4.2ea558","type":"comment","z":"9582ddcc.9ab69","name":"Circadian Lighting (using sun position)","info":"","x":470,"y":20,"wires":[]},{"id":"75c5ff3f.6d63f","type":"change","z":"9582ddcc.9ab69","name":"set payload altitudePercent","rules":[{"t":"set","p":"payload","pt":"msg","to":"{ \"color_temp\": $.payload.altitudePercent }","tot":"jsonata"}],"action":"","property":"","from":"","to":"","reg":false,"x":520,"y":240,"wires":[["7c1f8a94.024834"]]},{"id":"b444a3e9.1707d","type":"server-state-changed","z":"9582ddcc.9ab69","name":"If light on","server":"63c71c5f.ed2ac4","version":1,"exposeToHomeAssistant":false,"haConfig":[{"property":"name","value":""},{"property":"icon","value":""}],"entityidfilter":"^light.","entityidfiltertype":"regex","outputinitially":false,"state_type":"str","haltifstate":"on","halt_if_type":"str","halt_if_compare":"is","outputs":2,"output_only_on_state_change":true,"x":100,"y":120,"wires":[["4c40b30a.c987dc"],[]]},{"id":"7f024588.8bda2c","type":"ha-get-entities","z":"9582ddcc.9ab69","server":"63c71c5f.ed2ac4","name":"Get all Lights","rules":[{"property":"entity_id","logic":"is","value":"^light.","valueType":"re"}],"output_type":"array","output_empty_results":false,"output_location_type":"msg","output_location":"payload.lights","output_results_count":1,"x":470,"y":360,"wires":[["7eba231e.7ab48c"]]},{"id":"7eba231e.7ab48c","type":"function","z":"9582ddcc.9ab69","name":"Iterate lights","func":"const { lights, ...rest } = msg.payload;\n\nif(!Array.isArray(lights)) {\n    msg.payload.light = [msg.payload.lights];\n    return msg;\n}\n\nlights.forEach(light => {\n    node.send({\n        payload: {\n            light,\n            ...rest\n        }\n    });\n});","outputs":1,"noerr":0,"x":470,"y":420,"wires":[["a275ca05.577a28"]]},{"id":"7e9ae420.2070cc","type":"change","z":"9582ddcc.9ab69","name":"Set light to entity_id and attributes","rules":[{"t":"set","p":"payload","pt":"msg","to":"{ \"light\": $.msg.data }","tot":"jsonata"},{"t":"set","p":"payload.light.attributes","pt":"msg","to":"payload.light.new_state.attributes","tot":"msg"},{"t":"delete","p":"data","pt":"msg"},{"t":"delete","p":"topic","pt":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":180,"y":240,"wires":[["ecd8728d.b5b68"]]},{"id":"a275ca05.577a28","type":"switch","z":"9582ddcc.9ab69","name":"Filter lights by \"on\"","property":"payload.light.state","propertyType":"msg","rules":[{"t":"eq","v":"on","vt":"str"}],"checkall":"true","repair":false,"outputs":1,"x":490,"y":460,"wires":[["ecd8728d.b5b68"]]},{"id":"1ee61075.b807a","type":"api-call-service","z":"9582ddcc.9ab69","name":"Set light color_temp","server":"63c71c5f.ed2ac4","version":1,"debugenabled":false,"service_domain":"light","service":"turn_on","entityId":"","data":"{\t   \"entity_id\" : $.payload.light.entity_id,\t   \"color_temp\": $flowContext(\"color_temp\")\t}","dataType":"jsonata","mergecontext":"","output_location":"payload","output_location_type":"msg","mustacheAltTags":false,"x":640,"y":600,"wires":[[]]},{"id":"79e72a72.481f74","type":"trigger-state","z":"9582ddcc.9ab69","name":"All light changes","server":"63c71c5f.ed2ac4","exposeToHomeAssistant":false,"haConfig":[{"property":"name","value":""},{"property":"icon","value":""}],"entityid":"^light.","entityidfiltertype":"regex","debugenabled":false,"constraints":[],"constraintsmustmatch":"all","outputs":2,"customoutputs":[],"outputinitially":false,"state_type":"str","x":140,"y":660,"wires":[["24ce0faa.4dc22","d0dc9ba9.6cebf8"],[]]},{"id":"24ce0faa.4dc22","type":"switch","z":"9582ddcc.9ab69","name":"If color_temp changed","property":"data.event.old_state.attributes.color_temp","propertyType":"msg","rules":[{"t":"neq","v":"data.event.new_state.attributes.color_temp","vt":"msg"}],"checkall":"true","repair":false,"outputs":1,"x":360,"y":660,"wires":[["6dc1f9cd.700778"]]},{"id":"d0dc9ba9.6cebf8","type":"switch","z":"9582ddcc.9ab69","name":"If rgb changed","property":"payload","propertyType":"msg","rules":[{"t":"jsonata_exp","v":"$.data.event.old_state.attributes.rgb_color \t    != $.data.event.new_state.attributes.rgb_color","vt":"jsonata"}],"checkall":"true","repair":false,"outputs":1,"x":340,"y":700,"wires":[["a8402a1c.9a3008"]]},{"id":"a8402a1c.9a3008","type":"function","z":"9582ddcc.9ab69","name":"Add light to uncontrolled lights","func":"const entity_id = msg.data.entity_id;\nconst uncontrolled_lights = flow.get(\"uncontrolled_lights\");\n\nconst new_uncontrolled_lights = uncontrolled_lights === undefined ?\n    [entity_id] : [...new Set([...uncontrolled_lights, entity_id])];\n\nflow.set(\"uncontrolled_lights\", new_uncontrolled_lights);\nmsg.payload = { uncontrolled_lights: new_uncontrolled_lights };\nreturn msg;","outputs":1,"noerr":0,"x":610,"y":700,"wires":[[]]},{"id":"6dc1f9cd.700778","type":"function","z":"9582ddcc.9ab69","name":"Remove light from uncontrolled lights","func":"const entity_id = msg.data.entity_id;\nconst uncontrolled_lights = flow.get(\"uncontrolled_lights\");\n\nconst new_uncontrolled_lights = uncontrolled_lights === undefined ?\n    [] : uncontrolled_lights.filter(ul_entity_id => ul_entity_id !== entity_id);\n\nflow.set(\"uncontrolled_lights\", new_uncontrolled_lights);\nmsg.payload = { uncontrolled_lights: new_uncontrolled_lights };\nreturn msg;","outputs":1,"noerr":0,"x":630,"y":660,"wires":[[]]},{"id":"e3892d8c.ec25d","type":"function","z":"9582ddcc.9ab69","name":"Is light uncontrolled","func":"const entity_id = msg.payload.light.entity_id;\nconst uncontrolled_lights = flow.get(\"uncontrolled_lights\");\n\nif (uncontrolled_lights === undefined ||\n        !uncontrolled_lights.includes(entity_id)) {\n    return msg;\n}\n","outputs":1,"noerr":0,"x":150,"y":600,"wires":[["2721ae6f.0969a2"]]},{"id":"2721ae6f.0969a2","type":"switch","z":"9582ddcc.9ab69","name":"If color_temp is not set already","property":"payload.light.attributes.color_temp","propertyType":"msg","rules":[{"t":"neq","v":"color_temp","vt":"flow"}],"checkall":"true","repair":false,"outputs":1,"x":390,"y":600,"wires":[["1ee61075.b807a"]]},{"id":"400181bb.2fc33","type":"change","z":"9582ddcc.9ab69","name":"Set flow.color_temp","rules":[{"t":"set","p":"color_temp","pt":"flow","to":"payload.color_temp","tot":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":500,"y":320,"wires":[["7f024588.8bda2c"]]},{"id":"91342192.fd869","type":"server-state-changed","z":"329a6d0c.defab2","name":"Humidity Change","server":"63c71c5f.ed2ac4","version":1,"exposeToHomeAssistant":false,"haConfig":[{"property":"name","value":""},{"property":"icon","value":""}],"entityidfilter":"sensor.master_bedroom_humidity","entityidfiltertype":"exact","outputinitially":false,"state_type":"num","haltifstate":"","halt_if_type":"str","halt_if_compare":"is","outputs":1,"output_only_on_state_change":true,"x":100,"y":240,"wires":[["a9fb83b4.689e4"]]},{"id":"4c40b30a.c987dc","type":"api-current-state","z":"9582ddcc.9ab69","name":"If Main Flux is on","server":"63c71c5f.ed2ac4","version":1,"outputs":2,"halt_if":"on","halt_if_type":"str","halt_if_compare":"is","override_topic":false,"entity_id":"input_boolean.main_flux","state_type":"str","state_location":"","override_payload":"none","entity_location":"","override_data":"none","blockInputOverrides":false,"x":170,"y":180,"wires":[["7e9ae420.2070cc"],[]]},{"id":"cf14760b.801858","type":"api-current-state","z":"9582ddcc.9ab69","name":"If Main Flux is on","server":"63c71c5f.ed2ac4","version":1,"outputs":2,"halt_if":"on","halt_if_type":"str","halt_if_compare":"is","override_topic":false,"entity_id":"input_boolean.main_flux","state_type":"str","state_location":"","override_payload":"none","entity_location":"","override_data":"none","blockInputOverrides":false,"x":490,"y":120,"wires":[["757d78fd.7247d8"],[]]},{"id":"5ddf97d5.0d7158","type":"server-state-changed","z":"9582ddcc.9ab69","name":"Main Flux turned on","server":"63c71c5f.ed2ac4","version":1,"exposeToHomeAssistant":false,"haConfig":[{"property":"name","value":""},{"property":"icon","value":""}],"entityidfilter":"input_boolean.main_flux","entityidfiltertype":"exact","outputinitially":false,"state_type":"str","haltifstate":"on","halt_if_type":"str","halt_if_compare":"is","outputs":2,"output_only_on_state_change":true,"x":250,"y":60,"wires":[["757d78fd.7247d8"],[]]},{"id":"a9fb83b4.689e4","type":"api-current-state","z":"329a6d0c.defab2","name":"Is Humidity Control on","server":"63c71c5f.ed2ac4","version":1,"outputs":2,"halt_if":"on","halt_if_type":"str","halt_if_compare":"is","override_topic":false,"entity_id":"input_boolean.humidity_control","state_type":"str","state_location":"","override_payload":"none","entity_location":"","override_data":"none","blockInputOverrides":false,"x":300,"y":240,"wires":[["723bc947.f173a8"],[]]},{"id":"ecd8728d.b5b68","type":"function","z":"9582ddcc.9ab69","name":"Is not hue group","func":"const is_hue_group = msg.payload.light.attributes.is_hue_group;\n\nif (is_hue_group === undefined ||\n        is_hue_group === false) {\n    return msg;\n}\n","outputs":1,"noerr":0,"x":380,"y":500,"wires":[["805b961e.d81308"]]},{"id":"8a6acec9.2159f","type":"function","z":"9582ddcc.9ab69","name":"Read light.yaml","func":"msg.payload = context.global.fs.readFileSync('/config/light.yaml', 'utf8');\n\nreturn msg;","outputs":1,"noerr":0,"x":780,"y":120,"wires":[["1bbf42c9.0a02fd"]]},{"id":"1bbf42c9.0a02fd","type":"yaml","z":"9582ddcc.9ab69","property":"payload","name":"Parse light.yaml","x":780,"y":160,"wires":[["911b5b70.a642a8"]]},{"id":"911b5b70.a642a8","type":"function","z":"9582ddcc.9ab69","name":"Get groups","func":"const entries = msg.payload;\nif (!entries) {\n    return;\n}\n\nreturn {\n    payload: {\n        light_groups: entries.reduce(\n            (light_groups, entry) => {\n                    if (entry.platform === \"group\") {\n                        light_groups.push(\n                            `light.${\n                                entry.name.replace(/\\s/g, '_').toLowerCase()\n                                \n                            }`\n                        );\n                    }\n                    return light_groups;\n                },\n            []\n        )\n    }\n};","outputs":1,"noerr":0,"x":770,"y":200,"wires":[["845b5ad8.ddee58"]]},{"id":"845b5ad8.ddee58","type":"change","z":"9582ddcc.9ab69","name":"Set flow.light_groups","rules":[{"t":"set","p":"light_groups","pt":"flow","to":"payload.light_groups","tot":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":800,"y":240,"wires":[[]]},{"id":"805b961e.d81308","type":"function","z":"9582ddcc.9ab69","name":"Is not ha group","func":"const entity_id = msg.payload.light.entity_id;\nconst light_groups = flow.get(\"light_groups\");\n\nif (!light_groups) {\n    return;\n}\n\nif (!light_groups.includes(entity_id)) {\n    return msg;\n}\n","outputs":1,"noerr":0,"x":380,"y":540,"wires":[["e3892d8c.ec25d"]]}]